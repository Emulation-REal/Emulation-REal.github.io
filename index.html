<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talkomatic Pro</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-color: #00cc00;
            --secondary-bg: #2c2c2c;
            --border-color: #444444;
        }
        [data-theme="blue"] {
            --accent-color: #00aaff;
        }
        [data-theme="purple"] {
            --accent-color: #cc00ff;
        }
        [data-theme="red"] {
            --accent-color: #ff4444;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        #main-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #header {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #header h1 {
            margin: 0;
            font-size: 28px;
            color: var(--accent-color);
        }
        #controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #username-container, #server-container, #theme-container {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        input, select, button {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #333;
            color: var(--text-color);
            font-size: 14px;
        }
        button {
            background-color: var(--accent-color);
            color: #000;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #00b300;
        }
        #status {
            color: var(--accent-color);
            text-align: center;
            margin: 10px 0;
        }
        #chat-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .user-chat {
            width: 300px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .user-header {
            padding: 10px;
            background-color: #333;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .typing-indicator {
            font-size: 12px;
            color: #888;
        }
        .chat-display {
            height: 200px;
            padding: 10px;
            overflow-y: auto;
            background-color: #222;
        }
        .message {
            margin: 5px 0;
            font-size: 14px;
        }
        .message .content {
            color: var(--text-color);
        }
        .chat-input {
            display: flex;
            padding: 10px;
        }
        .chat-input input {
            flex-grow: 1;
            border: none;
            background-color: #333;
        }
        .chat-input button {
            padding: 8px 12px;
        }
        @media (max-width: 600px) {
            .user-chat {
                width: 100%;
            }
            #controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="header">
            <h1>Talkomatic Pro</h1>
        </div>
        <div id="controls">
            <div id="username-container">
                <input type="text" id="username-input" placeholder="Enter username">
                <button id="set-username">Set Username</button>
            </div>
            <div id="server-container">
                <input type="text" id="server-input" placeholder="Enter or create server ID">
                <button id="join-server">Join/Create Server</button>
            </div>
            <div id="theme-container">
                <select id="theme-select">
                    <option value="green">Green</option>
                    <option value="blue">Blue</option>
                    <option value="purple">Purple</option>
                    <option value="red">Red</option>
                </select>
            </div>
        </div>
        <div id="status">Connecting...</div>
        <div id="chat-container"></div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        const chatContainer = document.getElementById('chat-container');
        const usernameInput = document.getElementById('username-input');
        const setUsernameButton = document.getElementById('set-username');
        const serverInput = document.getElementById('server-input');
        const joinServerButton = document.getElementById('join-server');
        const themeSelect = document.getElementById('theme-select');
        const status = document.getElementById('status');
        const usernameContainer = document.getElementById('username-container');

        // Generate or retrieve user ID
        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = 'user-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', userId);
        }

        let username = localStorage.getItem('username') || 'Anonymous';
        let currentServer = localStorage.getItem('currentServer') || null;
        let peer = null;
        let connections = {};
        let typingTimeouts = {};

        // Initialize PeerJS
        function initPeer() {
            peer = new Peer(userId, {
                host: 'peerjs-server.herokuapp.com',
                secure: true,
                port: 443
            });

            peer.on('open', (id) => {
                status.textContent = `Connected as ${username} (${id.slice(0, 8)})`;
                if (currentServer) {
                    joinServer(currentServer);
                }
            });

            peer.on('connection', (conn) => {
                setupConnection(conn);
            });

            peer.on('error', (err) => {
                status.textContent = `Error: ${err.type}`;
                console.error(err);
            });
        }

        // Create user chat box
        function createChatBox(peerId, peerUsername) {
            if (document.getElementById(`chat-${peerId}`)) return;
            const userChat = document.createElement('div');
            userChat.classList.add('user-chat');
            userChat.id = `chat-${peerId}`;
            userChat.innerHTML = `
                <div class="user-header">
                    <span>${peerUsername} (${peerId.slice(0, 8)})</span>
                    <span class="typing-indicator" id="typing-${peerId}"></span>
                </div>
                <div class="chat-display" id="display-${peerId}"></div>
                <div class="chat-input">
                    <input type="text" id="input-${peerId}" placeholder="Type a message...">
                    <button onclick="sendMessage('${peerId}')">Send</button>
                </div>
            `;
            chatContainer.appendChild(userChat);
            const input = document.getElementById(`input-${peerId}`);
            input.addEventListener('input', () => sendTypingIndicator(peerId));
            return userChat;
        }

        // Setup connection
        function setupConnection(conn) {
            const peerId = conn.peer;
            if (!connections[peerId]) {
                connections[peerId] = conn;
                conn.on('data', (data) => {
                    if (data.type === 'message') {
                        displayMessage(peerId, data);
                        broadcastMessage(data, peerId);
                    } else if (data.type === 'typing') {
                        showTypingIndicator(peerId);
                    } else if (data.type === 'username') {
                        updateUsername(peerId, data.username);
                    }
                });
                conn.on('close', () => {
                    delete connections[peerId];
                    const chatBox = document.getElementById(`chat-${peerId}`);
                    if (chatBox) chatBox.remove();
                    status.textContent = `Connected peers: ${Object.keys(connections).length}`;
                });
                createChatBox(peerId, data.username || 'Anonymous');
                status.textContent = `Connected peers: ${Object.keys(connections).length}`;
                // Send current username
                conn.send({ type: 'username', username });
            }
        }

        // Join or create server
        function joinServer(serverId) {
            currentServer = serverId;
            localStorage.setItem('currentServer', serverId);
            const knownPeers = JSON.parse(localStorage.getItem(`peers_${serverId}`) || '[]');
            knownPeers.forEach(peerId => {
                if (peerId !== userId && !connections[peerId]) {
                    const conn = peer.connect(peerId);
                    conn.on('open', () => {
                        setupConnection(conn);
                    });
                }
            });
            serverInput.value = serverId;
        }

        // Display message
        function displayMessage(peerId, data) {
            const display = document.getElementById(`display-${peerId}`);
            if (display) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.innerHTML = `<span class="content">${data.message}</span>`;
                display.appendChild(messageElement);
                display.scrollTop = display.scrollHeight;
            }
        }

        // Broadcast message
        function broadcastMessage(data, senderId) {
            Object.keys(connections).forEach(peerId => {
                if (peerId !== senderId) {
                    connections[peerId].send(data);
                }
            });
        }

        // Send message
        window.sendMessage = (peerId) => {
            const input = document.getElementById(`input-${peerId}`);
            const message = input.value.trim();
            if (message && connections[peerId]) {
                const data = { type: 'message', userId, username, message };
                displayMessage(peerId, data);
                connections[peerId].send(data);
                broadcastMessage(data, peerId);
                input.value = '';
                // Update known peers
                if (currentServer) {
                    const knownPeers = [...new Set([...JSON.parse(localStorage.getItem(`peers_${currentServer}`) || '[]'), peerId])];
                    localStorage.setItem(`peers_${currentServer}`, JSON.stringify(knownPeers));
                }
            }
        };

        // Send typing indicator
        function sendTypingIndicator(peerId) {
            if (connections[peerId]) {
                connections[peerId].send({ type: 'typing', userId });
                clearTimeout(typingTimeouts[peerId]);
                typingTimeouts[peerId] = setTimeout(() => {
                    const typing = document.getElementById(`typing-${peerId}`);
                    if (typing) typing.textContent = '';
                }, 2000);
            }
        }

        // Show typing indicator
        function showTypingIndicator(peerId) {
            const typing = document.getElementById(`typing-${peerId}`);
            if (typing) {
                typing.textContent = 'Typing...';
                clearTimeout(typingTimeouts[peerId]);
                typingTimeouts[peerId] = setTimeout(() => {
                    typing.textContent = '';
                }, 2000);
            }
        }

        // Update username
        function updateUsername(peerId, newUsername) {
            const header = document.querySelector(`#chat-${peerId} .user-header span`);
            if (header) {
                header.textContent = `${newUsername} (${peerId.slice(0, 8)})`;
            }
        }

        // Set username
        setUsernameButton.addEventListener('click', () => {
            const newUsername = usernameInput.value.trim();
            if (newUsername) {
                username = newUsername;
                localStorage.setItem('username', username);
                usernameContainer.style.display = 'none';
                status.textContent = `Connected as ${username} (${userId.slice(0, 8)})`;
                Object.values(connections).forEach(conn => {
                    conn.send({ type: 'username', username });
                });
            }
        });

        // Join server
        joinServerButton.addEventListener('click', () => {
            const serverId = serverInput.value.trim();
            if (serverId) {
                joinServer(serverId);
            }
        });

        // Theme selection
        themeSelect.addEventListener('change', () => {
            document.body.setAttribute('data-theme', themeSelect.value);
            localStorage.setItem('theme', themeSelect.value);
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'green';
        themeSelect.value = savedTheme;
        document.body.setAttribute('data-theme', savedTheme);

        // Hide username input if set
        if (localStorage.getItem('username')) {
            usernameContainer.style.display = 'none';
        }

        // Initialize PeerJS
        initPeer();
    </script>
</body>
</html>
